name: Lighthouse Performance Audit

on:
  issue_comment:
    types: [created]

jobs:
  lighthouse-audit:
    # Only run on PR comments that contain the trigger phrase
    if: github.event.issue.pull_request && contains(github.event.comment.body, 'RUN_COMMIT_CRAB')
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: React to trigger comment
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '22'
          
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          npm install -g lighthouse
          npm install -g http-server

      - name: Setup Chrome
        uses: browser-actions/setup-chrome@v2
        with:
          chrome-version: stable
          install-dependencies: true

      - name: Start local server for PR files
        run: |
          # Start a local HTTP server in the background
          http-server . -p 8080 -c-1 --cors &
          SERVER_PID=$!
          echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
          
          # Wait for server to start
          sleep 3
          
          # Check if server is running
          curl -f http://localhost:8080/ || echo "Server check failed"

      - name: Extract URL from comment
        id: extract-url
        uses: actions/github-script@v8
        with:
          script: |
            const comment = context.payload.comment.body;
            
            // Extract URL from comment (look for URLs after RUN_COMMIT_CRAB)
            const urlMatch = comment.match(/RUN_COMMIT_CRAB\s+(https?:\/\/[^\s]+)/i);
            
            // Check for local file reference (e.g., RUN_COMMIT_CRAB test-page.html)
            const localFileMatch = comment.match(/RUN_COMMIT_CRAB\s+([^\s]+\.html?)/i);
            
            let targetUrl = 'https://www.browserstack.com/users/sign_in'; // default
            
            if (urlMatch && urlMatch[1]) {
              targetUrl = urlMatch[1];
            } else if (localFileMatch && localFileMatch[1]) {
              targetUrl = `http://localhost:8080/${localFileMatch[1]}`;
            } else if (comment.includes('RUN_COMMIT_CRAB') && !urlMatch) {
              // If just RUN_COMMIT_CRAB with no URL, check for test-page.html
              targetUrl = 'http://localhost:8080/test-page.html';
            }
            
            core.setOutput('url', targetUrl);
            core.setOutput('is_local', targetUrl.includes('localhost') ? 'true' : 'false');
            console.log('Target URL:', targetUrl);
            console.log('Is local file:', targetUrl.includes('localhost'));

      - name: Run Lighthouse Audit
        id: lighthouse
        run: |
          TARGET_URL="${{ steps.extract-url.outputs.url }}"
          echo "Running Lighthouse audit on: $TARGET_URL"
          
          # Run lighthouse and capture the output
          lighthouse_output=$(lighthouse "$TARGET_URL" \
            --output=json \
            --quiet \
            --chrome-flags="--headless --no-sandbox --disable-dev-shm-usage" 2>/dev/null | jq '{
              FCP: .audits["first-contentful-paint"].displayValue,
              LCP: .audits["largest-contentful-paint"].displayValue,
              CLS: .audits["cumulative-layout-shift"].displayValue,
              TBT: .audits["total-blocking-time"].displayValue,
              TTI: .audits["interactive"].displayValue,
              Performance: .categories.performance.score
            }')
          
          echo "lighthouse_results<<EOF" >> $GITHUB_OUTPUT
          echo "$lighthouse_output" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "target_url<<EOF" >> $GITHUB_OUTPUT
          echo "$TARGET_URL" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Also save to a file for debugging
          echo "$lighthouse_output" > lighthouse-results.json
          cat lighthouse-results.json

      - name: Comment PR with results
        uses: actions/github-script@v8
        with:
          script: |
            const results = JSON.parse(`${{ steps.lighthouse.outputs.lighthouse_results }}`);
            
            // Calculate performance score percentage
            const perfScore = Math.round((results.Performance || 0) * 100);
            
            // Determine performance grade
            let grade = '🔴';
            if (perfScore >= 90) grade = '🟢';
            else if (perfScore >= 50) grade = '🟡';
            
            const comment = `## 🦀 Commit Crab Lighthouse Results ${grade}
            
            **Performance Score: ${perfScore}/100**
            ${results.Performance && results.Performance > 0 ? '' : '⚠️ *Note: This might be a local file test*'}
            
            ### Core Web Vitals
            | Metric | Value |
            |--------|--------|
            | **First Contentful Paint (FCP)** | ${results.FCP || 'N/A'} |
            | **Largest Contentful Paint (LCP)** | ${results.LCP || 'N/A'} |
            | **Cumulative Layout Shift (CLS)** | ${results.CLS || 'N/A'} |
            | **Total Blocking Time (TBT)** | ${results.TBT || 'N/A'} |
            | **Time to Interactive (TTI)** | ${results.TTI || 'N/A'} |
            
            ### Performance Recommendations
            ${perfScore >= 90 ? '✅ Excellent performance! Keep up the good work.' :
              perfScore >= 50 ? '⚠️ Good performance, but there\'s room for improvement.' :
              '❌ Performance needs attention. Consider optimizing critical resources.'}
            
            ${steps.extractUrl.outputs.is_local === 'true' ? 
              '### 📁 PR File Testing\n✅ This test was run against files from your Pull Request!\n' : ''}
            
            ---
            *Triggered by: @${{ github.event.comment.user.login }}*
            *URL tested: ${{ steps.lighthouse.outputs.target_url }}*
            *Commit: ${{ github.event.pull_request.head.sha || 'N/A' }}*
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Upload Lighthouse results
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-results
          path: lighthouse-results.json
          retention-days: 30
          
      - name: Cleanup
        if: always()
        run: |
          # Kill the local server if it's running
          if [ ! -z "$SERVER_PID" ]; then
            kill $SERVER_PID 2>/dev/null || echo "Server already stopped"
          fi